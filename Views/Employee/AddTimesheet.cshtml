@model Timesheets_APP.ViewModels.AddTimesheetViewModel

@{
    ViewData["Title"] = "Add Timesheet";
}

<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link"
           href="@Url.Action("Index", new { empId = Model.EmpId })">
            Your Timesheets
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link active">
            Add Timesheet
        </a>
    </li>
</ul>

<div class="tab-content border border-top-0 p-3">
    <h3>Please enter your timesheet details below.</h3>

    <form asp-action="AddTimesheet"
          method="post">
        <input asp-for="EmpId"
               type="hidden" />

        <div class="form-group">
            <label asp-for="EmpName"></label>
            <input asp-for="EmpName"
                   class="form-control"
                   readonly />
        </div>

        <div class="form-group">
            <label asp-for="TsDate"></label>
            <select asp-for="TsDate"
                    asp-items="Model.TsDateOptions"
                    class="form-control">
            </select>
        </div>

        <p>Select your start and end time (click the clock icon to select time). Then click Enter Time.</p>

        <div class="form-row align-items-end">
            <div class="col-md-4">
                <label asp-for="StartTime"></label>
                <input asp-for="StartTime"
                       class="form-control"
                       type="time" />
            </div>
            <div class="col-md-4">
                <label asp-for="EndTime"></label>
                <input asp-for="EndTime"
                       class="form-control"
                       type="time" />
            </div>
            <div class="col-md-4">
                <button type="button"
                        id="enterTime"
                        class="btn btn-primary">
                    Enter Time
                </button>
            </div>
        </div>

        <div id="timeItemsSection"
             class="mt-4"
             style="display:none;">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>To</th>
                        <th>Describe What You Did</th>
                    </tr>
                </thead>
                <tbody id="timeItemsBody">
                </tbody>
            </table>
        </div>

        <button type="submit"
                class="btn btn-success">
            Save Time
        </button>
        <a asp-action="Index"
           asp-route-empId="@Model.EmpId"
           class="btn btn-secondary ml-2">
            Cancel
        </a>
    </form>
</div>
<form asp-action="AddTimesheet" method="post">
    @Html.AntiForgeryToken()
    <input asp-for="EmpId" type="hidden" />
    …
</form>


@section Scripts {
    <script>
        function formatTime(d) {
            let h = d.getHours();
            let m = d.getMinutes();
            let ampm = h >= 12 ? "PM" : "AM";
            h = h % 12 || 12;
            m = (m < 10 ? "0" : "") + m;
            return h + ":" + m + " " + ampm;
        }

        document
            .getElementById("enterTime")
            .addEventListener("click", () => {
                let startVal = document
                    .querySelector("input[name='StartTime']")
                    .value;
                let endVal = document
                    .querySelector("input[name='EndTime']")
                    .value;

                let [sh, sm] = startVal.split(":").map(Number);
                let [eh, em] = endVal.split(":").map(Number);

                let current = new Date();
                current.setHours(sh, sm, 0, 0);
                let endTime = new Date();
                endTime.setHours(eh, em, 0, 0);

                let rows = "";
                let idx = 0;
                while (current < endTime) {
                    let next = new Date(current.getTime() + 60*60000);
                    rows += `<tr>
                        <td>
                          <input name="Items[${idx}].TimeFrom"
                                 class="form-control"
                                 readonly
                                 value="${formatTime(current)}" />
                        </td>
                        <td>
                          <input name="Items[${idx}].TimeOut"
                                 class="form-control"
                                 readonly
                                 value="${formatTime(next)}" />
                        </td>
                        <td>
                          <input name="Items[${idx}].Description"
                                 class="form-control"
                                 placeholder="Enter text here." />
                        </td>
                    </tr>`;
                    idx++;
                    current = next;
                }

                document.getElementById("timeItemsBody").innerHTML = rows;
                document.getElementById("timeItemsSection").style.display = "";
            });
    </script>
}
